---
phase: 04-project-local-streams
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/source.rs
  - src/capture.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "Running `lazytail -n test` inside a project creates stream in .lazytail/data/"
    - "Running `lazytail -n test` outside any project creates stream in ~/.config/lazytail/data/"
    - ".lazytail/ directory created with secure permissions (mode 0700)"
  artifacts:
    - path: "src/source.rs"
      provides: "Context-aware directory resolution functions"
      exports: ["resolve_data_dir", "resolve_sources_dir", "create_secure_dir"]
    - path: "src/capture.rs"
      provides: "Capture mode with discovery-aware directory selection"
      contains: "run_capture_mode.*discovery"
  key_links:
    - from: "src/capture.rs"
      to: "src/source.rs"
      via: "resolve_data_dir(discovery)"
      pattern: "resolve_data_dir.*discovery"
    - from: "src/main.rs"
      to: "src/capture.rs"
      via: "passes DiscoveryResult to capture mode"
      pattern: "run_capture_mode.*discovery"
---

<objective>
Add context-aware directory resolution to source.rs and integrate with capture mode so that `lazytail -n` writes to project-local `.lazytail/data/` when inside a project, or global `~/.config/lazytail/data/` when outside.

Purpose: Enable project-scoped stream capture, keeping project logs separate from global logs.
Output: Modified source.rs with new functions, updated capture.rs and main.rs to pass discovery context.
</objective>

<execution_context>
@/home/raay/.claude/get-shit-done/workflows/execute-plan.md
@/home/raay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-project-local-streams/04-RESEARCH.md
@src/source.rs
@src/capture.rs
@src/config/discovery.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context-aware directory functions to source.rs</name>
  <files>src/source.rs</files>
  <action>
Add three new functions to source.rs:

1. `create_secure_dir(path: &Path) -> io::Result<()>`:
   - Use `std::fs::DirBuilder::new().recursive(true)`
   - On Unix: use `std::os::unix::fs::DirBuilderExt` to set `.mode(0o700)`
   - Use `#[cfg(unix)]` for the mode setting (Windows uses default permissions)

2. `resolve_data_dir(discovery: &DiscoveryResult) -> Option<PathBuf>`:
   - If `discovery.project_root` is Some, return `project_root.join(".lazytail").join("data")`
   - Otherwise, fall back to `dirs::config_dir().map(|p| p.join("lazytail").join("data"))`
   - Import `DiscoveryResult` from `crate::config::DiscoveryResult`

3. `resolve_sources_dir(discovery: &DiscoveryResult) -> Option<PathBuf>`:
   - Same pattern as resolve_data_dir but with "sources" subdirectory
   - If `discovery.project_root` is Some, return `project_root.join(".lazytail").join("sources")`
   - Otherwise, fall back to global sources directory

4. `ensure_directories_for_context(discovery: &DiscoveryResult) -> Result<()>`:
   - Use `resolve_data_dir(discovery)` and `resolve_sources_dir(discovery)` to get paths
   - Call `create_secure_dir()` for each
   - Return appropriate anyhow errors with context

Keep the existing `data_dir()`, `sources_dir()`, and `ensure_directories()` functions for backward compatibility with discovery mode (which will be updated in Plan 02).

Add the necessary imports at the top:
```rust
use crate::config::DiscoveryResult;
#[cfg(unix)]
use std::os::unix::fs::DirBuilderExt;
```

Add unit tests for the new functions:
- Test `create_secure_dir` creates directory with correct permissions (Unix only)
- Test `resolve_data_dir` returns project path when project_root is Some
- Test `resolve_data_dir` returns global path when project_root is None
  </action>
  <verify>
`cargo build` compiles without errors.
`cargo test source::tests` passes (including new tests).
  </verify>
  <done>
New functions `create_secure_dir`, `resolve_data_dir`, `resolve_sources_dir`, and `ensure_directories_for_context` exist in source.rs, are properly typed, and compile successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate context-aware capture mode</name>
  <files>src/capture.rs, src/main.rs</files>
  <action>
Update capture.rs:

1. Change `run_capture_mode` signature to accept discovery:
   ```rust
   pub fn run_capture_mode(name: String, discovery: &DiscoveryResult) -> Result<()>
   ```

2. Replace `ensure_directories()` call with `ensure_directories_for_context(discovery)?`

3. Replace `data_dir()` call with `resolve_data_dir(discovery)`:
   ```rust
   let log_path = resolve_data_dir(discovery)
       .context("Could not determine data directory")?
       .join(format!("{}.log", name));
   ```

4. Update the marker functions to use context-aware directories. Change:
   - `check_source_status` to accept optional discovery and use `resolve_sources_dir`
   - `create_marker` to accept discovery and use `resolve_sources_dir(discovery)`
   - `remove_marker` to accept discovery and use `resolve_sources_dir(discovery)`

   OR simpler approach: Add new context-aware variants:
   - `check_source_status_for_context(name: &str, discovery: &DiscoveryResult) -> SourceStatus`
   - `create_marker_for_context(name: &str, discovery: &DiscoveryResult) -> Result<()>`
   - `remove_marker_for_context(name: &str, discovery: &DiscoveryResult) -> Result<()>`

   Use the simpler approach (new functions) to avoid breaking existing code that Plan 02 will update.

5. Update the header message to show location:
   ```rust
   let location = if discovery.project_root.is_some() {
       "project"
   } else {
       "global"
   };
   eprintln!("Serving \"{}\" -> {} ({})", name, log_path.display(), location);
   ```

6. Add import: `use crate::source::{resolve_data_dir, ensure_directories_for_context, ...};`

Update main.rs:

1. Change the capture mode call at line ~180 from:
   ```rust
   return capture::run_capture_mode(name);
   ```
   to:
   ```rust
   return capture::run_capture_mode(name, &discovery);
   ```

The discovery result is already available at that point in main.rs.
  </action>
  <verify>
`cargo build` compiles without errors.
`cargo test capture::tests` passes.
`cargo clippy` has no new warnings.
  </verify>
  <done>
Capture mode accepts DiscoveryResult, uses context-aware directory functions, and main.rs passes discovery to capture mode. Running `lazytail -n test` in a directory with lazytail.yaml will create files in `.lazytail/data/`.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. `cargo test` passes (existing tests + new tests)
3. `cargo clippy` has no new warnings
4. `cargo fmt -- --check` passes

Manual verification (optional, for confidence):
- In a directory with lazytail.yaml: `echo "test" | cargo run -- -n test` should show "(project)" in output
- In a directory without lazytail.yaml: `echo "test" | cargo run -- -n test` should show "(global)" in output
</verification>

<success_criteria>
- [ ] `resolve_data_dir(discovery)` returns project path when in project, global otherwise
- [ ] `create_secure_dir` creates directories with mode 0700 on Unix
- [ ] `run_capture_mode` accepts and uses DiscoveryResult
- [ ] Capture mode output shows "(project)" or "(global)" to indicate storage location
- [ ] All existing tests pass
- [ ] No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/04-project-local-streams/04-01-SUMMARY.md`
</output>
