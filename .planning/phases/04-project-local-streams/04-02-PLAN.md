---
phase: 04-project-local-streams
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/source.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "Discovery mode shows both project-local and global streams"
    - "Project-local streams appear before global streams in the list"
    - "Streams from different locations can be distinguished"
  artifacts:
    - path: "src/source.rs"
      provides: "Discovery that scans both project and global directories"
      exports: ["discover_sources_for_context", "SourceLocation"]
    - path: "src/main.rs"
      provides: "Discovery mode uses context-aware source discovery"
      contains: "discover_sources_for_context"
  key_links:
    - from: "src/main.rs"
      to: "src/source.rs"
      via: "discover_sources_for_context(discovery)"
      pattern: "discover_sources_for_context.*discovery"
    - from: "src/source.rs"
      to: "src/config/discovery.rs"
      via: "uses DiscoveryResult for directory resolution"
      pattern: "DiscoveryResult"
---

<objective>
Update discovery mode to scan both project-local `.lazytail/data/` and global `~/.config/lazytail/data/` directories, showing sources from both locations with visual distinction.

Purpose: Users can see all available streams regardless of where they were captured, with project-local streams taking precedence in display order.
Output: Modified source.rs with dual-location discovery, updated main.rs to use it.
</objective>

<execution_context>
@/home/raay/.claude/get-shit-done/workflows/execute-plan.md
@/home/raay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-project-local-streams/04-RESEARCH.md
@.planning/phases/04-project-local-streams/04-01-SUMMARY.md
@src/source.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SourceLocation enum and context-aware discovery</name>
  <files>src/source.rs</files>
  <action>
Add `SourceLocation` enum to track where a source was discovered:

```rust
/// Location where a source was discovered
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum SourceLocation {
    /// Source is in project-local .lazytail/data/
    Project,
    /// Source is in global ~/.config/lazytail/data/
    Global,
}
```

Add `location` field to `DiscoveredSource`:
```rust
pub struct DiscoveredSource {
    pub name: String,
    pub log_path: PathBuf,
    pub status: SourceStatus,
    pub location: SourceLocation,  // NEW field
}
```

Update existing `discover_sources()` to set `location: SourceLocation::Global` for backward compatibility (it only looks at global).

Add new function `discover_sources_for_context(discovery: &DiscoveryResult) -> Result<Vec<DiscoveredSource>>`:

1. Create empty `sources` Vec
2. If `discovery.project_root` is Some:
   - Get project data dir via `resolve_data_dir(discovery)` (from Plan 01)
   - If it exists, scan it and add sources with `location: SourceLocation::Project`
3. Always scan global data dir via `data_dir()`:
   - If it exists, scan it for sources
   - Skip any source with the same name as one already in `sources` (project shadows global)
   - Add remaining with `location: SourceLocation::Global`
4. Return combined list (project sources first, then global)

Extract a helper function `scan_data_directory(dir: &Path, location: SourceLocation) -> Result<Vec<DiscoveredSource>>` to avoid code duplication. This should be the core of the existing `discover_sources()` logic but accepting location.

Update `check_source_status` to use `check_source_status_for_context` internally when location is known, or keep the existing global-only behavior as default.

Add tests:
- Test that project sources appear before global sources
- Test that project source shadows global source with same name
- Test empty project dir doesn't break discovery
  </action>
  <verify>
`cargo build` compiles without errors.
`cargo test source::tests` passes.
  </verify>
  <done>
`SourceLocation` enum exists, `DiscoveredSource` has `location` field, `discover_sources_for_context()` scans both directories and returns combined results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate context-aware discovery in main.rs</name>
  <files>src/main.rs</files>
  <action>
Update `run_discovery_mode` function to use context-aware discovery:

1. Change the signature to accept discovery:
   ```rust
   fn run_discovery_mode(
       no_watch: bool,
       cfg: config::Config,
       mut config_errors: Vec<String>,
       discovery: &DiscoveryResult,  // NEW parameter
   ) -> Result<()>
   ```

2. Replace:
   ```rust
   ensure_directories()?;
   let sources = discover_sources()?;
   ```
   With:
   ```rust
   use source::{discover_sources_for_context, ensure_directories_for_context};
   ensure_directories_for_context(discovery)?;
   let sources = discover_sources_for_context(discovery)?;
   ```

3. Update the directory watcher to watch the appropriate directory based on context:
   ```rust
   let dir_watcher = if watch {
       // Watch project data dir if in project, otherwise global
       let watch_dir = if discovery.project_root.is_some() {
           source::resolve_data_dir(discovery)
       } else {
           source::data_dir()
       };
       watch_dir.and_then(|p| dir_watcher::DirectoryWatcher::new(p).ok())
   } else {
       None
   };
   ```

4. Update the call site in `main()` at line ~185:
   ```rust
   return run_discovery_mode(args.no_watch, cfg, config_errors, &discovery);
   ```

5. Update `from_discovered_source` usage to handle the new `location` field (if TabState needs to know the location for display purposes, or just pass it through).

Check if `tab.rs` needs any updates - if `DiscoveredSource` is used there, the new field should be handled gracefully (likely just ignored for now, but verify compilation).

Add appropriate imports at the top of main.rs:
```rust
use source::{discover_sources_for_context, ensure_directories_for_context, resolve_data_dir};
```
  </action>
  <verify>
`cargo build` compiles without errors.
`cargo test` passes.
`cargo clippy` has no new warnings.
`cargo fmt -- --check` passes.
  </verify>
  <done>
Discovery mode uses `discover_sources_for_context()`, scans both project and global directories, and watches the appropriate directory for new sources.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. `cargo test` passes
3. `cargo clippy` has no new warnings
4. `cargo fmt -- --check` passes

Manual verification (to confirm full flow):
1. Create a test project with lazytail.yaml
2. Capture a stream: `echo "project log" | cargo run -- -n proj-test`
3. In a directory without lazytail.yaml, capture: `echo "global log" | cargo run -- -n glob-test`
4. Run discovery mode in the project: `cargo run` - should show both proj-test (project) and glob-test (global)
5. Verify proj-test appears before glob-test in the tab list
</verification>

<success_criteria>
- [ ] `SourceLocation` enum with `Project` and `Global` variants exists
- [ ] `DiscoveredSource` has `location` field
- [ ] `discover_sources_for_context` scans both project and global directories
- [ ] Project sources shadow global sources with the same name
- [ ] Discovery mode uses context-aware functions
- [ ] Directory watcher watches appropriate directory based on context
- [ ] All tests pass
- [ ] No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/04-project-local-streams/04-02-SUMMARY.md`
</output>
