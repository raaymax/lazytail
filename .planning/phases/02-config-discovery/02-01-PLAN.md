---
phase: 02-config-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/mod.rs
  - src/config/discovery.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "Running lazytail in a subdirectory finds lazytail.yaml in parent directories"
    - "Running lazytail in a directory with lazytail.yaml recognizes it as project root"
    - "Running lazytail without any config file works normally using defaults"
    - "Global config at ~/.config/lazytail/config.yaml is detected when present"
  artifacts:
    - path: "src/config/mod.rs"
      provides: "Config module re-exports"
      contains: "pub mod discovery"
    - path: "src/config/discovery.rs"
      provides: "Config discovery logic"
      exports: ["discover", "DiscoveryResult"]
      min_lines: 50
  key_links:
    - from: "src/main.rs"
      to: "src/config/discovery.rs"
      via: "mod config; config::discovery::discover()"
      pattern: "config::discovery::discover"
    - from: "src/config/discovery.rs"
      to: "dirs::config_dir()"
      via: "global config path resolution"
      pattern: "dirs::config_dir"
---

<objective>
Create config discovery module that walks parent directories to find lazytail.yaml and checks for global config.

Purpose: Enable project-scoped configuration by finding where configs are located. Phase 3 will load and merge them.
Output: `src/config/discovery.rs` with `discover()` function returning discovered paths, integrated into main.rs.
</objective>

<execution_context>
@/home/raay/.claude/get-shit-done/workflows/execute-plan.md
@/home/raay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-config-discovery/02-CONTEXT.md
@.planning/phases/02-config-discovery/02-RESEARCH.md
@src/signal.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config discovery module with tests</name>
  <files>src/config/mod.rs, src/config/discovery.rs</files>
  <action>
Create `src/config/` directory with two files:

**src/config/mod.rs:**
```rust
pub mod discovery;
pub use discovery::{discover, DiscoveryResult};
```

**src/config/discovery.rs:**
Create the discovery module following the research pattern:

1. Constants:
   - `PROJECT_CONFIG_NAME: &str = "lazytail.yaml"`
   - `GLOBAL_CONFIG_NAME: &str = "config.yaml"`
   - `DATA_DIR_NAME: &str = ".lazytail"`

2. `DiscoveryResult` struct with:
   - `project_root: Option<PathBuf>` - directory containing lazytail.yaml
   - `project_config: Option<PathBuf>` - full path to lazytail.yaml
   - `global_config: Option<PathBuf>` - path to ~/.config/lazytail/config.yaml
   - `data_dir()` method returning `Option<PathBuf>` (project_root.join(".lazytail"))
   - `has_config()` method returning bool
   - Derive: Debug, Clone, Default

3. `discover()` function:
   - Check global config first using `dirs::config_dir()` -> join("lazytail") -> join("config.yaml")
   - Get cwd with `std::env::current_dir()`, canonicalize it (fallback to uncanonicalized on error)
   - Walk `start.ancestors()` looking for `lazytail.yaml`
   - Use `path.try_exists().unwrap_or(false) && path.is_file()` for safe existence checks
   - First match wins (closest config)
   - Return DiscoveryResult

4. `discover_verbose() -> (DiscoveryResult, Vec<PathBuf>)`:
   - Same logic but collects all searched paths for -v output

5. Tests (mark slow tests with #[ignore]):
   - `test_finds_config_in_current_dir` - config in temp dir, discover from there
   - `test_finds_config_in_parent_dir` - config in parent, discover from subdir
   - `test_no_config_returns_defaults` - empty temp dir, discover returns None for project_config
   - `test_data_dir_derived_from_project_root` - verify data_dir() returns project_root/.lazytail
   - `test_has_config_methods` - verify has_config() logic

Use tempfile::TempDir for tests. Save and restore cwd in each test.
  </action>
  <verify>
Run: `cargo test config::discovery --no-fail-fast`
All tests pass.
Run: `cargo clippy -- -D warnings`
No warnings in new code.
  </verify>
  <done>
Discovery module exists with discover() function that:
- Returns DiscoveryResult with project_root, project_config, global_config fields
- Walks ancestors from cwd looking for lazytail.yaml
- Checks ~/.config/lazytail/config.yaml for global config
- All unit tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate discovery into main.rs</name>
  <files>src/main.rs</files>
  <action>
Wire discovery into application startup:

1. Add `mod config;` to main.rs (near other mod declarations)

2. In main() function, AFTER cleanup_stale_markers() and BEFORE mode dispatch:
   - Call `let discovery = config::discovery::discover();`
   - For now, just store the result (Phase 3 will use it for config loading)

3. Add verbose discovery output (when -v flag is present):
   - Check if clap args has verbose flag (may need to add -v flag if not present)
   - If verbose: print discovery results to stderr
     ```
     [discovery] Project root: /path/to/project
     [discovery] Project config: /path/to/lazytail.yaml
     [discovery] Global config: ~/.config/lazytail/config.yaml (or "not found")
     ```
   - Use eprintln! for discovery output (stderr, not stdout)

4. If -v flag doesn't exist in Args struct:
   - Add `#[arg(short = 'v', long, help = "Verbose output")]` to Args
   - Add `pub verbose: bool` field

Note: Don't change any other behavior yet - discovery just runs and reports. Phase 3 will actually use the config.
  </action>
  <verify>
Run: `cargo build`
Compiles without errors.

Run: `cargo run -- -v /dev/null 2>&1 | grep "\[discovery\]"`
Shows discovery output lines.

Run: `cargo run -- /dev/null`
No discovery output (non-verbose mode).

Run: `cargo test`
All tests pass (including existing tests).
  </verify>
  <done>
Discovery runs at startup:
- `mod config;` declared in main.rs
- discover() called after cleanup_stale_markers()
- -v flag shows discovery results to stderr
- Normal operation unchanged (no output without -v)
  </done>
</task>

</tasks>

<verification>
Phase success criteria from ROADMAP:

1. "Running lazytail in a subdirectory finds lazytail.yaml in parent directories"
   - Test: Create lazytail.yaml in /tmp/test/, cd /tmp/test/sub/, run `lazytail -v /dev/null`
   - Expect: Discovery output shows project root as /tmp/test/

2. "Running lazytail in a directory with .lazytail/ recognizes it as project root"
   - SKIPPED: Per CONTEXT.md, only lazytail.yaml signals project root, not .lazytail/

3. "Running lazytail without any config file works normally using defaults"
   - Test: cd /tmp (no lazytail.yaml), run `lazytail -v /dev/null`
   - Expect: Discovery shows "Project config: not found", app runs normally

4. "Discovery stops at filesystem boundaries"
   - Test: Discovery walks to / and stops (verified by unit tests)

Note: Success criterion #2 from ROADMAP was clarified in CONTEXT.md - only lazytail.yaml signals project root.
</verification>

<success_criteria>
- [ ] `src/config/discovery.rs` exists with discover() function
- [ ] DiscoveryResult struct has project_root, project_config, global_config fields
- [ ] Unit tests verify discovery behavior
- [ ] main.rs calls discover() at startup
- [ ] -v flag shows discovery search results
- [ ] All cargo test, cargo clippy pass
- [ ] App works normally without any config file
</success_criteria>

<output>
After completion, create `.planning/phases/02-config-discovery/02-01-SUMMARY.md`
</output>
